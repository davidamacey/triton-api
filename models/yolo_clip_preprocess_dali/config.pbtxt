# Track E Simple: YOLO + CLIP DALI Preprocessing (Fast)
# GPU-accelerated preprocessing for YOLO (640×640) + MobileCLIP (256×256)
# NO original_images output = fixed-size outputs only = fast!
#
# Inputs:
#   - encoded_images: JPEG/PNG bytes
#   - affine_matrices: YOLO letterbox transformation [2, 3]
#
# Outputs:
#   - yolo_images: [N, 3, 640, 640] FP32
#   - clip_images: [N, 3, 256, 256] FP32

name: "yolo_clip_preprocess_dali"
backend: "dali"
max_batch_size: 64  # Match Track D for fair comparison

input [
  {
    name: "encoded_images"
    data_type: TYPE_UINT8
    dims: [ -1 ]
  },
  {
    name: "affine_matrices"
    data_type: TYPE_FP32
    dims: [ 2, 3 ]
  }
]

output [
  {
    name: "yolo_images"
    data_type: TYPE_FP32
    dims: [ 3, 640, 640 ]
  },
  {
    name: "clip_images"
    data_type: TYPE_FP32
    dims: [ 3, 256, 256 ]
  }
]

# High throughput configuration
instance_group [
  {
    count: 8
    kind: KIND_GPU
    gpus: [ 0 ]
  }
]

dynamic_batching {
  preferred_batch_size: [ 16, 32, 64 ]  # Match Track D for fair comparison
  max_queue_delay_microseconds: 200000  # 200ms - match Track D
  preserve_ordering: false

  # Queue policy to prevent server deadlock under high load
  default_queue_policy {
    timeout_action: REJECT
    default_timeout_microseconds: 10000000  # 10 seconds - handles complex CLIP+YOLO pipeline
    allow_timeout_override: false
    max_queue_size: 256  # Reject excess requests gracefully (HTTP 503)
  }
}

parameters: {
  key: "num_threads"
  value: { string_value: "4" }
}
